

window.fn = {};

window.fn.open = function () {

    var menu = document.getElementById('menu');
    menu.open();
};

window.fn.load = function (page) {
    var content = document.getElementById('content');
    var menu = document.getElementById('menu');


    content.load(page)
        .then(menu.close.bind(menu));
};


document.addEventListener('init', function (event) {

    if (event.target.id == "home") {
        openDb();
        getItems();
    }
    if (event.target.id == "cadastro") {
        horario();

    }

});



var db = null;

function onError(tx, e) {

    alert("algo errado " + e.message);
}

function onSucess(tx, r) {

    getItems();
}


function openDb() {



    db = openDatabase("despertador", "1", "despertador list", 1024 * 1024);



    db.transaction(function (tx) {
        tx.executeSql("CREATE TABLE IF NOT EXISTS despertador (ID INTEGER PRIMARY KEY ASC,descricao TEXT, hora TEXT,minuto TEXT, obs text)", []);
    });


}


function getItems() {

    db.transaction(function (tx) {
        tx.executeSql("SELECT * FROM despertador", [], renderItems, onError);

    });

}

function renderItems(tx, rs) {

    var output = "";
    var list = document.getElementById("lista");


    for (i = 0; i < rs.rows.length; i++) {
        var row = rs.rows.item(i);
        output += "<ons-list-item>" + row.descricao;
        output += " <i class='fa fa-clock-o'  aria-hidden='true'></i> " + row.hora + ':' + row.minuto;
        output += "<div class=\"rigth\"><ons-button onclick='deleteItem(" + row.ID + ");'>";
        output += "<ons-icon icon=\"trash\"></ons-icon></ons-button><ons-button onclick='editItem(" + row.ID + ");'><ons-icon icon=\"pencil\"></ons-icon></ons-button></div>";
        output += "</ons-list-item>";
      

    }

    list.innerHTML = output;

}


function addItem(descricao, hora, minuto, obs) {
    var descricao = document.getElementById("descricao").value;
    var hora = document.getElementById("hora").value;
    var minuto = document.getElementById("minuto").value;
    var obs = document.getElementById("obs").value;

    db.transaction(function (tx) {
        tx.executeSql("INSERT INTO  despertador (descricao,hora,minuto,obs) VALUES (?,?,?,?)", [descricao, hora, minuto, obs], onSucess, onError);
        // tx.executeSql("INSERT INTO  despertador (descr) VALUES (  '1' )");

    });

    fn.load("home.html");

}



function deleteItem(id) {

    db.transaction(function (tx) {
        tx.executeSql("DELETE FROM despertador WHERE id= ?", [id], onSucess, onError);

    });
}

function editItem(id) {
    alert('id = ' + id);
    //db.transaction(function (tx) {
    //  tx.executeSql("DELETE FROM items WHERE id= ?",[id],onSucess,onError);
    // });

}

function horario() {
    var data = new Date();
    var horaAtual = data.getHours();
    var minutoAtual = data.getMinutes();
    var montaMinuto = '';
    var montaHora = '';

    montaHora += ' hora: <br> <ons-select  name="hora"  id="hora" onchange="editSelects(event)">';
    for (var j = 1; j < 25; j++) {


        if (j == horaAtual) {
            montaHora += '<option value="' + j + '" selected >' + j + '</option>';
        } else {
            montaHora += '<option value="' + j + '" >' + j + '</option>';
        }

    }
    montaHora += '</ons-select>';
    var hora = document.getElementById('div-hora');
    hora.innerHTML = montaHora;


    montaMinuto += 'minuto: <br><ons-select name="minuto" id="minuto"  onchange="editSelects(event)">';
    for (var i = 0; i < 60; i++) {

        if (i == minutoAtual) {
            montaMinuto += '<option value="' + i + '"  selected>' + i + '</option>';
        } else {

            montaMinuto += '<option value="' + i + '" >' + i + '</option>';
        }
    }
    montaMinuto += '</ons-select>';
    var minuto = document.getElementById('div-minuto');
    minuto.innerHTML = montaMinuto;

}

var myVar = setInterval(function () { despertador() }, 60000);

function despertador() {
    var data = new Date();
    var horaAtual = data.getHours();
    var minutoAtual = data.getMinutes();




    var itemVerificado = [];
    db.transaction(function (tx) {
        tx.executeSql('SELECT * FROM despertador', [], function (tx, results) {
            var len = results.rows.length, i;
            msg = "<p>Found rows: " + len + "</p>";
            //document.querySelector('#status').innerHTML +=  msg;
            console.log(msg);
            for (i = 0; i < len; i++) {
                var horaItem = results.rows.item(i).hora;
                var minutoItem = results.rows.item(i).minuto;
                var descricaoItem = results.rows.item(i).descricao;
                var id = results.rows.item(i).id;
                var obsItem = results.rows.item(i).obs;
                //console.log(results.rows.item(i).descricao);
                if (minutoAtual == minutoItem && horaAtual == horaItem) {
                    itemVerificado.push(id);
                    // alert('despertador! '+descricaoItem );
                    ons.notification.alert({
                        message: descricaoItem + '<br>\n\r' + horaItem + ':' + minutoItem

                    });
                }

                //  alert(results.rows.item(i).log );
            }

        }, null);
    });
    console.log(itemVerificado);


}