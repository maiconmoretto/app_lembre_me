

window.fn = {};

window.fn.open = function () {

    var menu = document.getElementById('menu');
    menu.open();
};

window.fn.load = function (page) {
    var content = document.getElementById('content');
    var menu = document.getElementById('menu');


    content.load(page)
    .then(menu.close.bind(menu));
};


document.addEventListener('init', function (event) {

    if (event.target.id == "home") {
        openDb();
        getItems();
    }
    if (event.target.id == "cadastro") {
        openDb();
        horario();

    }
    if (event.target.id == "historico") {
        openDb();
        getItemsHistorico();
    }

});



var db = null;

function onError(tx, e) {

    alert("algo errado " + e.message);
}

function onSucess(tx, r) {

    getItems();
}


function openDb() {


    db = openDatabase("bd", "1", "despertador list", 1024 * 1024);


    db.transaction(function (tx) {
        tx.executeSql("CREATE TABLE IF NOT EXISTS despertador (id INTEGER PRIMARY KEY ASC,descricao TEXT, hora INTEGER,minuto INTEGER, obs text, dt_cadastro  DATETIME DEFAULT  CURRENT_TIMESTAMP,despertou BOOLEAN)", []);
        
    });

    db.transaction(function (tx) {
     tx.executeSql("CREATE TABLE IF NOT EXISTS historico (id INTEGER PRIMARY KEY ASC,descricao TEXT, hora INTEGER,minuto INTEGER, obs text, despertou BOOLEAN,dt_cadastro  DATETIME DEFAULT  CURRENT_TIMESTAMP)", []);
 }); 





}


function dropAll(){


    db.transaction(function (tx) {
      tx.executeSql("DELETE * FROM  historico ", []);
  });
    db.transaction(function (tx) {
      tx.executeSql("DELETE * FROM  despertador ", []);
  });
    db.transaction(function (tx) {
     tx.executeSql("DROP TABLE  despertador ", []);
 });
    db.transaction(function (tx) {
      tx.executeSql("DROP TABLE  historico ", []);
  });
    db.transaction(function (tx) {
        tx.executeSql("DROP TABLE bd", []);
    });
}

function getItems() {

    db.transaction(function (tx) {
        tx.executeSql("SELECT * FROM despertador", [], renderItems, onError);
    });

}

function getItemsHistorico() {

    db.transaction(function (tx) {
        tx.executeSql("SELECT * FROM historico", [], renderItemsHistorico, onError);
    });

}

function renderItems(tx, rs) {

    var output = "";
    var list = document.getElementById("lista");


    if (rs.rows.length == 0) {
        output += "<ons-list-item>sem lembretes cadastrados</ons-list-item>";
        list.innerHTML = output;
    }

    for (i = 0; i < rs.rows.length; i++) {
        var row = rs.rows.item(i);
        output += "<ons-list-item>" + row.descricao+"&nbsp;&nbsp;";
        output += " <i class='fa fa-clock-o'  aria-hidden='true'></i> " + row.hora + ':' + row.minuto+"&nbsp;&nbsp;";

        output += "<div class=\"rigth\"><ons-button onclick='checkAlarm(" + row.id + ");'>";
        output += "<ons-icon icon=\"check\"> tomei</ons-icon></ons-button></div>&nbsp;";
        output += "<div class=\"rigth\"><ons-button onclick='deleteItem(" + row.id + ");'>";
        output += "<ons-icon icon=\"trash\"></ons-icon></ons-button></div>";
        //<i class='fa fa-check' aria-hidden='true'></i>
        //<ons-button onclick='editItem(" + row.ID + ");'><ons-icon icon=\"pencil\"></ons-icon></ons-button>
        output += "</ons-list-item>";
    }

    list.innerHTML = output;

}

function renderItemsHistorico(tx, rs) {

    var output = "";
    var list = document.getElementById("lista");


    if (rs.rows.length == 0) {
        output += "<ons-list-item>sem historico(s) cadastrado(s)</ons-list-item>";
        list.innerHTML = output;
    }

    for (i = 0; i < rs.rows.length; i++) {
        var row = rs.rows.item(i);
        output += "<ons-list-item>" + row.descricao+"&nbsp;&nbsp;";
        output += " <i class='fa fa-clock-o'  aria-hidden='true'></i> " + row.hora + ':' + row.minuto+"&nbsp;&nbsp;";
        output += "cadastrado em: " + row.dt_cadastro.substring(8,10) +'/'+row.dt_cadastro.substring(5, 7)+'/'+row.dt_cadastro.substring(0, 4) + ', as '+row.dt_cadastro.substring(11, 19) ;
        output += "</ons-list-item>";

    }

    list.innerHTML = output;

}


function addItem(descricao, hora, minuto, obs) {
    var descricao = document.getElementById("descricao").value;
    var hora = document.getElementById("hora").value;
    var minuto = document.getElementById("minuto").value;
    var obs = document.getElementById("obs").value;
    var repetir = document.getElementById("repetir").value;
    var cadastroRepetir = 24 / repetir;

    if(descricao == "" ){

        ons.notification.alert({
            message: "Preencha o campo descricao"

        })
        return false;
    }else if(repetir == ""){
        ons.notification.alert({
            message: "Preencha o campo repetir"

        })
        return false;
    }


    for (var i = 0; i < cadastroRepetir; i++) {
        var novaHora = "";
        novaHora = parseInt(i * repetir) + parseInt(hora);
        novaHora = novaHora > 24 ? Math.round(novaHora - 24) : novaHora;
        this.insereSQL(descricao, novaHora, minuto, obs);

    }

    fn.load("home.html");

}

function insereSQL(descricao, hora, minuto, obs){

    db.transaction(function (tx) {
        tx.executeSql("INSERT INTO  despertador (descricao,hora,minuto,obs,despertou) VALUES (?,?,?,?,'false')", [descricao, hora, minuto, obs], onSucess, onError);
    });

}




function insereSQLHistorico(descricao, hora, minuto, obs){

    db.transaction(function (tx) {
        tx.executeSql("INSERT INTO  historico (descricao,hora,minuto,obs,despertou) VALUES (?,?,?,?,'true')", [descricao, hora, minuto, obs], onSucess, onError);
    });

}

function deleteItem(id) {

    db.transaction(function (tx) {
        tx.executeSql("DELETE FROM despertador WHERE id= ?", [id], onSucess, onError);

    });
}



function checkAlarm(id) {

    db.transaction(function (tx) {
        tx.executeSql("UPDATE  despertador SET despertou = 'true' WHERE id = ?", [id], onSucess, onError);

    });


    db.transaction(function (tx) {
        tx.executeSql('SELECT * FROM despertador WHERE id = ? ', [id], function (tx, results) {
            var len = results.rows.length, i;

            for (i = 0; i < len; i++) {
                var horaItem = results.rows.item(i).hora;
                var minutoItem = results.rows.item(i).minuto;
                var descricaoItem = results.rows.item(i).descricao;
                var id = results.rows.item(i).id;
                var obsItem = results.rows.item(i).obs;
                this.insereSQLHistorico(descricaoItem, horaItem, minutoItem, obsItem);
            }

        }, null);
    });
    ons.notification.alert({
        message:'Adicionado ao histÃ³rico'

    });


}


function editItem(id) {
    alert('id = ' + id);
    //db.transaction(function (tx) {
    //  tx.executeSql("DELETE FROM items WHERE id= ?",[id],onSucess,onError);
    // });

}

function horario() {
    var data = new Date();
    var horaAtual = data.getHours();
    var minutoAtual = data.getMinutes();
    var montaMinuto = '';
    var montaHora = '';

    montaHora += ' hora: <br> <ons-select  name="hora"  id="hora" onchange="editSelects(event)">';
    for (var j = 1; j < 25; j++) {


        if (j == horaAtual) {
            montaHora += '<option value="' + j + '" selected >' + j + '</option>';
        } else {
            montaHora += '<option value="' + j + '" >' + j + '</option>';
        }

    }
    montaHora += '</ons-select>';
    var hora = document.getElementById('div-hora');
    hora.innerHTML = montaHora;


    montaMinuto += 'minuto: <br><ons-select name="minuto" id="minuto"  onchange="editSelects(event)">';
    for (var i = 0; i < 60; i++) {

        if (i == minutoAtual) {
            montaMinuto += '<option value="' + i + '"  selected>' + i + '</option>';
        } else {

            montaMinuto += '<option value="' + i + '" >' + i + '</option>';
        }
    }
    montaMinuto += '</ons-select>';
    var minuto = document.getElementById('div-minuto');
    minuto.innerHTML = montaMinuto;

}

var myVar = setInterval(function () { despertador() }, 1000);

function despertador() {

    var data = new Date();
    var horaAtual = data.getHours();
    var minutoAtual = data.getMinutes();

    db.transaction(function (tx) {
        tx.executeSql("SELECT * FROM despertador WHERE despertou = 'false' ", [], function (tx, results) {

            var len = results.rows.length, i;
            msg = "<p>Found rows: " + len + "</p>";

            for (i = 0; i < len; i++) {
              var horaItem = results.rows.item(i).hora;
              var minutoItem = results.rows.item(i).minuto;
              var descricaoItem = results.rows.item(i).descricao;
              var id = results.rows.item(i).id;
              var obsItem = results.rows.item(i).obs;


              if (horaAtual == horaItem && minutoAtual == minutoItem  ) {

                ons.notification.alert({
                    message: descricaoItem + '<br>\n\r' + horaItem + ':' + minutoItem

                })
                this.checkAlarm(id);

            }


        }

    })
    })
}