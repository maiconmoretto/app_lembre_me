
window.fn = {};

window.fn.open = function () {

    var menu = document.getElementById('menu');
    menu.open();
};

window.fn.load = function (page) {
    var content = document.getElementById('content');
    var menu = document.getElementById('menu');


    content.load(page)
    .then(menu.close.bind(menu));
};


document.addEventListener('init', function (event) {

    if (event.target.id == "home") {
        openDb();
        getItems();
    }
    if (event.target.id == "cadastro") {
        openDb();
        horario();

    }
    if (event.target.id == "historico") {
        openDb();
        getItemsHistorico();
    }

});



var db = null;

function onError(tx, e) {

    alert("algo errado " + e.message);
}

function onSucess(tx, r) {

    getItems();
}


function openDb() {

   //dropAll();
  //return 
  db = openDatabase("bd", "1", "despertador list", 1024 * 1024);


  db.transaction(function (tx) {
    tx.executeSql("CREATE TABLE IF NOT EXISTS despertador (ID INTEGER PRIMARY KEY ASC,descricao TEXT, hora INTEGER,minuto INTEGER, obs text, dt_cadastro  DATETIME DEFAULT  CURRENT_TIMESTAMP)", []);
    
});

  db.transaction(function (tx) {
     tx.executeSql("CREATE TABLE IF NOT EXISTS historico (ID INTEGER PRIMARY KEY ASC,descricao TEXT, hora INTEGER,minuto INTEGER, obs text, despertou BOOLEAN)", []);
 }); 





}


function dropAll(){
    db.transaction(function (tx) {
        tx.executeSql("DROP TABLE bd", []);
    });
    db.transaction(function (tx) {
     tx.executeSql("DROP TABLE  despertador ", []);
 })

    db.transaction(function (tx) {
      tx.executeSql("DROP TABLE  historico ", []);
  })
}

function getItems() {

    db.transaction(function (tx) {
        tx.executeSql("SELECT * FROM despertador", [], renderItems, onError);
    });

}

function getItemsHistorico() {

    db.transaction(function (tx) {
        tx.executeSql("SELECT * FROM historico", [], renderItemsHistorico, onError);
    });

}

function renderItems(tx, rs) {

    var output = "";
    var list = document.getElementById("lista");


    if (rs.rows.length == 0) {
        output += "<ons-list-item>sem lembretes cadastrados</ons-list-item>";
        list.innerHTML = output;
    }

    for (i = 0; i < rs.rows.length; i++) {
        var row = rs.rows.item(i);
        output += "<ons-list-item>" + row.descricao+"&nbsp;&nbsp;";
        output += " <i class='fa fa-clock-o'  aria-hidden='true'></i> " + row.hora + ':' + row.minuto+"&nbsp;&nbsp;";
        output += "<div class=\"rigth\"><ons-button onclick='deleteItem(" + row.ID + ");'>";
        output += "<ons-icon icon=\"trash\"></ons-icon></ons-button></div>";
        output += "<div class=\"rigth\"><ons-button onclick='checkAlarm(" + row.ID + ");'>";
        output += "<ons-icon icon=\"check\"></ons-icon></ons-button></div>&nbsp;";
        //<i class='fa fa-check' aria-hidden='true'></i>
        //<ons-button onclick='editItem(" + row.ID + ");'><ons-icon icon=\"pencil\"></ons-icon></ons-button>
        output += "</ons-list-item>";
    }

    list.innerHTML = output;

}

function renderItemsHistorico(tx, rs) {

    var output = "";
    var list = document.getElementById("lista");


    if (rs.rows.length == 0) {
        output += "<ons-list-item>sem lembretes cadastrados</ons-list-item>";
        list.innerHTML = output;
    }

    for (i = 0; i < rs.rows.length; i++) {
        var row = rs.rows.item(i);
        output += "<ons-list-item>" + row.descricao+"&nbsp;&nbsp;";
        output += " <i class='fa fa-clock-o'  aria-hidden='true'></i> " + row.hora + ':' + row.minuto+"&nbsp;&nbsp;";
        output += "cadastrado em:";
        output += "</ons-list-item>";

    }

    list.innerHTML = output;

}


function addItem(descricao, hora, minuto, obs) {
    var descricao = document.getElementById("descricao").value;
    var hora = document.getElementById("hora").value;
    var minuto = document.getElementById("minuto").value;
    var obs = document.getElementById("obs").value;
    var repetir = document.getElementById("repetir").value;
    var cadastroRepetir = 24 / repetir;

    for (var i = 0; i < cadastroRepetir; i++) {
        var novaHora = "";
        novaHora = parseInt(i * repetir) + parseInt(hora);
        novaHora = novaHora > 24 ? Math.round(novaHora - 24) : novaHora;
        this.insereSQL(descricao, novaHora, minuto, obs);

    }

    fn.load("home.html");

}

function insereSQL(descricao, hora, minuto, obs){

    db.transaction(function (tx) {
        tx.executeSql("INSERT INTO  despertador (descricao,hora,minuto,obs) VALUES (?,?,?,?)", [descricao, hora, minuto, obs], onSucess, onError);
    });

}


function insereSQLHistorico(descricao, hora, minuto, obs){

    db.transaction(function (tx) {
        tx.executeSql("INSERT INTO  historico (descricao,hora,minuto,obs) VALUES (?,?,?,?)", [descricao, hora, minuto, obs], onSucess, onError);
    });

}

function deleteItem(id) {

    db.transaction(function (tx) {
        tx.executeSql("DELETE FROM despertador WHERE id= ?", [id], onSucess, onError);

    });
}

checkAlarm

function checkAlarm(id) {

    db.transaction(function (tx) {
        tx.executeSql("UPDATE  despertador SET despertou = 'true' WHERE id= ?", [id], onSucess, onError);

    });


    db.transaction(function (tx) {
        tx.executeSql('SELECT * FROM despertador WHERE id = ? ', [id], function (tx, results) {
            var len = results.rows.length, i;

            for (i = 0; i < len; i++) {
                var horaItem = results.rows.item(i).hora;
                var minutoItem = results.rows.item(i).minuto;
                var descricaoItem = results.rows.item(i).descricao;
                var id = results.rows.item(i).id;
                var obsItem = results.rows.item(i).obs;
                this.insereSQLHistorico(descricaoItem, horaItem, minutoItem, obsItem);
            }

        }, null);
    });
    ons.notification.alert({
        message:'Adicionado ao histÃ³rico'

    });


}


function editItem(id) {
    alert('id = ' + id);
    //db.transaction(function (tx) {
    //  tx.executeSql("DELETE FROM items WHERE id= ?",[id],onSucess,onError);
    // });

}

function horario() {
    var data = new Date();
    var horaAtual = data.getHours();
    var minutoAtual = data.getMinutes();
    var montaMinuto = '';
    var montaHora = '';

    montaHora += ' hora: <br> <ons-select  name="hora"  id="hora" onchange="editSelects(event)">';
    for (var j = 1; j < 25; j++) {


        if (j == horaAtual) {
            montaHora += '<option value="' + j + '" selected >' + j + '</option>';
        } else {
            montaHora += '<option value="' + j + '" >' + j + '</option>';
        }

    }
    montaHora += '</ons-select>';
    var hora = document.getElementById('div-hora');
    hora.innerHTML = montaHora;


    montaMinuto += 'minuto: <br><ons-select name="minuto" id="minuto"  onchange="editSelects(event)">';
    for (var i = 0; i < 60; i++) {

        if (i == minutoAtual) {
            montaMinuto += '<option value="' + i + '"  selected>' + i + '</option>';
        } else {

            montaMinuto += '<option value="' + i + '" >' + i + '</option>';
        }
    }
    montaMinuto += '</ons-select>';
    var minuto = document.getElementById('div-minuto');
    minuto.innerHTML = montaMinuto;

}

var myVar = setInterval(function () { despertador() }, 1000);

function despertador() {
    console.log('aqui');
    var data = new Date();
    var horaAtual = data.getHours();
    var minutoAtual = data.getMinutes();

    db.transaction(function (tx) {
        tx.executeSql('SELECT * FROM despertador WHERE despertou = null', [], function (tx, results) {
            var len = results.rows.length, i;
            msg = "<p>Found rows: " + len + "</p>";

            for (i = 0; i < len; i++) {
                var horaItem = results.rows.item(i).hora;
                var minutoItem = results.rows.item(i).minuto;
                var descricaoItem = results.rows.item(i).descricao;
                var id = results.rows.item(i).id;
                var obsItem = results.rows.item(i).obs;

                if (minutoAtual == minutoItem && horaAtual == horaItem) {

                    ons.notification.alert({
                        message: descricaoItem + '<br>\n\r' + horaItem + ':' + minutoItem

                      //  checkAlarm(id);
                  })

                }


            }

        })
    })
}



